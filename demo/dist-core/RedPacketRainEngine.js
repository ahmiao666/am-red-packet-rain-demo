"use strict";const t={containerWidth:"100%",containerHeight:"100%",count:20,density:5,speed:{min:2,max:6},size:{width:60,height:80},rotation:!0,rotationSpeed:{min:-.02,max:.02},enablePerformanceMode:!0,maxFPS:60,qualityMaxFPS:144,clickEffect:!0,isParticle:!0};exports.RedPacketRainEngine=class{constructor(e,i){this.redPackets=[],this.animationId=null,this.isRunning=!1,this.isPaused=!1,this.lastFrameTime=0,this.frameCount=0,this.lastFpsTime=0,this.currentFPS=0,this.lastSpawnTime=0,this.actualWidth=800,this.actualHeight=600,this.redPacketPool=[],this.poolSize=50,this.redPacketDataIndex=0,this.stats={totalCollected:0,totalValue:0,fps:0},this.redPacketImage=null,this.lastClickTime=0,this.clickDebounceDelay=100,this.debugClicks=[],this.particles=[],this.particlePool=[],this.particlePoolSize=100,this.particleConfig={count:15,speed:{min:2,max:8},size:{min:3,max:8},life:{min:800,max:1500},colors:["#FF6B6B"],gravity:.3,friction:.98,spread:2*Math.PI},this.canvas=e,this.ctx=e.getContext("2d"),this.config={...t,...i},this.optimizeConfig(),this.resizeCanvas(),this.initializePool(),this.initializeParticlePool(),this.bindEvents(),this.loadRedPacketImage()}initializePool(){for(let t=0;t<this.poolSize;t++)this.redPacketPool.push(this.createRedPacket())}initializeParticlePool(){for(let t=0;t<this.particlePoolSize;t++)this.particlePool.push(this.createParticle())}createParticle(){return{id:Math.random().toString(36).slice(2,11),x:0,y:0,vx:0,vy:0,size:5,opacity:1,color:"#FFD700",life:1,maxLife:1e3,gravity:.3,friction:.98,rotation:0,rotationSpeed:0}}getParticleFromPool(){return this.particlePool.pop()||this.createParticle()}returnParticleToPool(t){this.particlePool.length<this.particlePoolSize&&this.particlePool.push(t)}resetParticle(t,e,i){const a=this.particleConfig,s=Math.random()*a.spread,o=a.speed.min+Math.random()*(a.speed.max-a.speed.min);t.x=e,t.y=i,t.vx=Math.cos(s)*o,t.vy=Math.sin(s)*o-2*Math.random(),t.size=a.size.min+Math.random()*(a.size.max-a.size.min),t.initialSize=void 0,t.opacity=1,t.color=a.colors[Math.floor(Math.random()*a.colors.length)],t.maxLife=a.life.min+Math.random()*(a.life.max-a.life.min),t.life=t.maxLife,t.gravity=a.gravity,t.friction=a.friction,t.rotation=Math.random()*Math.PI*2,t.rotationSpeed=.2*(Math.random()-.5)}getRedPacketFromPool(){const t=this.redPacketPool.pop()||this.createRedPacket();return this.resetRedPacket(t),t}returnRedPacketToPool(t){this.redPacketPool.length<this.poolSize&&this.redPacketPool.push(t)}getRedPacketData(){if(!this.config.redPackets||"number"==typeof this.config.redPackets)return null;if(Array.isArray(this.config.redPackets)&&this.config.redPackets.length>0){const t=this.config.redPackets[this.redPacketDataIndex];return this.redPacketDataIndex=(this.redPacketDataIndex+1)%this.config.redPackets.length,t}return null}isSpecialRedPacket(t){return!!this.config.isSpecialFn&&("function"==typeof this.config.isSpecialFn?this.config.isSpecialFn(t):"string"==typeof this.config.isSpecialFn&&Boolean(t[this.config.isSpecialFn]))}createRedPacket(){const t=this.getRedPacketData(),e={id:Math.random().toString(36).slice(2,11),x:0,y:0,width:this.config.size.width,height:this.config.size.height,speed:0,rotation:0,rotationSpeed:0,scale:1,opacity:1,collected:!1,value:Math.floor(100*Math.random())+1,type:"normal",originalData:null};return t&&this.isUsingArrayMode()?(e.id=t.id||e.id,e.value=t.value||e.value,e.type=this.isSpecialRedPacket(t)?"special":"normal",e.originalData=t):(e.type="normal",e.originalData=null),e}resetRedPacket(t){const e=this.getRedPacketData();t.x=Math.random()*(this.actualWidth-this.config.size.width),t.y=-this.config.size.height,t.speed=Number(this.config.speed.min)+Math.random()*(Number(this.config.speed.max)-Number(this.config.speed.min)),t.rotation=0,t.rotationSpeed=this.config.rotation?this.config.rotationSpeed.min+Math.random()*(this.config.rotationSpeed.max-this.config.rotationSpeed.min):0,t.scale=.8+.4*Math.random(),t.opacity=1,t.collected=!1,e&&this.isUsingArrayMode()?(t.id=e.id||t.id,t.value=e.value||Math.floor(100*Math.random())+1,t.type=this.isSpecialRedPacket(e)?"special":"normal",t.originalData=e):(t.value=Math.floor(100*Math.random())+1,t.type="normal",t.originalData=null)}optimizeConfig(){this.config.redPackets&&Array.isArray(this.config.redPackets)&&this.config.redPackets.length>0?this.config.count=this.config.redPackets.length:(void 0===this.config.count||null===this.config.count||this.config.count<=0)&&(this.config.count=20)}isUsingArrayMode(){return!!(this.config.redPackets&&Array.isArray(this.config.redPackets)&&this.config.redPackets.length>0)}loadRedPacketImage(){this.config.redPacketImage&&("string"==typeof this.config.redPacketImage?(this.redPacketImage=new Image,this.redPacketImage.src=this.config.redPacketImage):this.redPacketImage=this.config.redPacketImage)}resizeCanvas(){let t=800,e=600;if("string"==typeof this.config.containerWidth&&this.config.containerWidth.includes("%")){const e=this.canvas.parentElement;e&&(t=e.clientWidth*parseFloat(this.config.containerWidth)/100)}else t="number"==typeof this.config.containerWidth?this.config.containerWidth:800;if("string"==typeof this.config.containerHeight&&this.config.containerHeight.includes("%")){const t=this.canvas.parentElement;t&&(e=t.clientHeight*parseFloat(this.config.containerHeight)/100)}else e="number"==typeof this.config.containerHeight?this.config.containerHeight:600;this.canvas.width=this.actualWidth=Math.max(100,Math.min(t,4e3)),this.canvas.height=this.actualHeight=Math.max(100,Math.min(e,4e3))}bindEvents(){this.canvas.addEventListener("click",this.handleClick.bind(this)),this.canvas.addEventListener("touchstart",this.handleTouch.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}handleClick(t){const e=this.getCanvasCoordinates(t.clientX,t.clientY);this.checkCollision(e.x,e.y,"mouse")}handleTouch(t){t.preventDefault();const e=t.touches[0],i=this.getCanvasCoordinates(e.clientX,e.clientY);this.checkCollision(i.x,i.y,"touch")}getCanvasCoordinates(t,e){const i=this.canvas.getBoundingClientRect(),a=i.width,s=i.height,o=this.canvas.width/a,n=this.canvas.height/s,c=(t-i.left)*o,l=(e-i.top)*n;return this.config.debugMode&&console.log(`üéØ ÁÇπÂáªÂùêÊ†áËΩ¨Êç¢:\n        ÂÆ¢Êà∑Á´ØÂùêÊ†á: (${t}, ${e})\n        CanvasÁü©ÂΩ¢: ${JSON.stringify(i)}\n        Áº©ÊîæÊØî‰æã: (${o.toFixed(3)}, ${n.toFixed(3)})\n        ÊúÄÁªàÂùêÊ†á: (${c.toFixed(1)}, ${l.toFixed(1)})`),{x:c,y:l}}handleResize(){this.resizeCanvas()}checkCollision(t,e,i="mouse"){const a=Date.now();if(a-this.lastClickTime<this.clickDebounceDelay)return void(this.config.debugMode&&console.log(`üéØ ÁÇπÂáªË¢´Èò≤ÊäñËøáÊª§ (Èó¥Èöî: ${a-this.lastClickTime}ms)`));this.lastClickTime=a,this.config.debugMode&&console.log(`üéØ Ê£ÄÊü•Á¢∞Êíû: (${t.toFixed(1)}, ${e.toFixed(1)}) [${i}]`);let s=!1;for(let i=this.redPackets.length-1;i>=0;i--){const a=this.redPackets[i];if(this.isPointInRedPacket(t,e,a)){this.config.debugMode&&console.log(`üéØ ÂëΩ‰∏≠Á∫¢ÂåÖ: ${a.id}, Á±ªÂûã: ${a.type}, ‰ª∑ÂÄº: ${a.value}`),this.collectRedPacket(a,t,e),this.redPackets.splice(i,1),this.returnRedPacketToPool(a),s=!0;break}}this.config.debugMode&&(this.debugClicks.push({x:t,y:e,time:a,hit:s}),s||(console.log(`üéØ Êú™ÂëΩ‰∏≠‰ªª‰ΩïÁ∫¢ÂåÖ - ÂΩìÂâçÁ∫¢ÂåÖÊï∞Èáè: ${this.redPackets.length}`),this.redPackets.slice(0,3).forEach((i,a)=>{const s=i.x+i.width/2,o=i.y+i.height/2,n=Math.sqrt((t-s)**2+(e-o)**2);console.log(`Á∫¢ÂåÖ${a+1}: ‰∏≠ÂøÉ(${s.toFixed(1)}, ${o.toFixed(1)}), Ë∑ùÁ¶ª: ${n.toFixed(1)}`)})))}isPointInRedPacket(t,e,i){const a=i.x+i.width/2,s=i.y+i.height/2,o=i.width*i.scale,n=i.height*i.scale,c=o+.1*o,l=n+.1*n,h=t>=a-c/2&&t<=a+c/2&&e>=s-l/2&&e<=s+l/2;return this.config.debugMode&&h&&console.log(`üéØ Á∫¢ÂåÖËæπÁïåÊ£ÄÊµã:\n        Á∫¢ÂåÖ‰∏≠ÂøÉ: (${a.toFixed(1)}, ${s.toFixed(1)})\n        ÂéüÂßãÂ∞∫ÂØ∏: ${o.toFixed(1)} x ${n.toFixed(1)}\n        Êâ©Â±ïÂ∞∫ÂØ∏: ${c.toFixed(1)} x ${l.toFixed(1)}\n        ÁÇπÂáªÂùêÊ†á: (${t.toFixed(1)}, ${e.toFixed(1)})\n        Ë∑ùÁ¶ª‰∏≠ÂøÉ: (${Math.abs(t-a).toFixed(1)}, ${Math.abs(e-s).toFixed(1)})`),h}collectRedPacket(t,e,i){t.collected=!0,this.stats.totalCollected++,this.stats.totalValue+=t.value,!this.config.enablePerformanceMode&&this.config.isParticle&&this.createRedPacketParticles(t,e,i),this.onRedPacketClickCallback&&this.onRedPacketClickCallback({redPacket:t,x:e,y:i,value:t.value})}createRedPacketParticles(t,e,i){const a=this.particleConfig.count,s="special"===t.type?1.5*a:a;for(let a=0;a<s;a++){const a=this.getParticleFromPool();this.resetParticle(a,e,i),"special"===t.type&&(a.color="#FFD700",a.size*=1.3),this.particles.push(a)}this.config.debugMode&&console.log(`üéÜ ÂàõÂª∫‰∫Ü ${s} ‰∏™Á≤íÂ≠ê [Á∫¢ÂåÖÁ±ªÂûã: ${t.type}]`)}updateParticles(t){const e=t/16.67;for(let i=this.particles.length-1;i>=0;i--){const a=this.particles[i];a.x+=a.vx*e,a.y+=a.vy*e,a.vy+=a.gravity*e,a.vx*=a.friction,a.vy*=a.friction,a.rotation+=a.rotationSpeed*e,a.life-=t;const s=Math.max(0,a.life/a.maxLife);a.opacity=s,a.initialSize||(a.initialSize=a.size);const o=.3+.7*s;a.size=a.initialSize*o,(a.life<=0||a.y>this.actualHeight+50)&&(this.particles.splice(i,1),this.returnParticleToPool(a))}}renderParticles(){const t=this.ctx;for(const e of this.particles){t.save(),t.globalAlpha=e.opacity,t.translate(e.x,e.y),t.rotate(e.rotation);const i=t.createRadialGradient(0,0,0,0,0,e.size);i.addColorStop(0,e.color),i.addColorStop(.7,e.color+"80"),i.addColorStop(1,e.color+"00"),t.fillStyle=i,t.beginPath(),t.arc(0,0,e.size,0,2*Math.PI),t.fill(),"#FFD700"!==e.color||this.config.enablePerformanceMode||(t.shadowColor=e.color,t.shadowBlur=2*e.size,t.beginPath(),t.arc(0,0,.5*e.size,0,2*Math.PI),t.fill()),t.restore()}}spawnRedPacket(){const t=Date.now(),e=1e3/this.config.density;if(t-this.lastSpawnTime>e&&this.redPackets.length<this.config.count){const e=this.getRedPacketFromPool();this.redPackets.push(e),this.lastSpawnTime=t}}updateRedPackets(t){for(let e=this.redPackets.length-1;e>=0;e--){const i=this.redPackets[e];i.y+=i.speed*(t/16.67),this.config.rotation&&(i.rotation+=i.rotationSpeed*(t/16.67)),i.y>this.actualHeight&&(this.redPackets.splice(e,1),this.returnRedPacketToPool(i))}}renderRedPackets(){this.ctx.clearRect(0,0,this.actualWidth,this.actualHeight),this.config.customStyles?.backgroundColor&&(this.ctx.fillStyle=this.config.customStyles.backgroundColor,this.ctx.fillRect(0,0,this.actualWidth,this.actualHeight));for(const t of this.redPackets)this.renderRedPacket(t)}renderRedPacket(t){const e=this.ctx,i=t.x+t.width/2,a=t.y+t.height/2;e.save(),e.globalAlpha=t.opacity,e.translate(i,a),this.config.rotation&&e.rotate(t.rotation),e.scale(t.scale,t.scale),this.config.enablePerformanceMode||"special"!==t.type||(e.shadowColor="#FFD700",e.shadowBlur=10),this.redPacketImage?e.drawImage(this.redPacketImage,-t.width/2,-t.height/2,t.width,t.height):this.drawDefaultRedPacket(e,t),e.restore()}drawDefaultRedPacket(t,e){const i=e.width,a=e.height;t.fillStyle="special"===e.type?"#FFD700":"#FF6B6B",t.fillRect(-i/2,-a/2,i,a),t.strokeStyle=this.config.customStyles?.borderColor||"#FF4444",t.lineWidth=2,t.strokeRect(-i/2,-a/2,i,a),t.fillStyle="#FFFFFF",t.font="20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("Ôø•",0,-5),e.value&&(t.font="10px Arial",t.fillText(e.value.toString(),0,8))}animate(t){if(!this.isRunning||this.isPaused)return;const e=1e3/(this.config.enablePerformanceMode?this.config.maxFPS:this.config.qualityMaxFPS||144),i=t-this.lastFrameTime;i<.9*e||(this.lastFrameTime=t,this.updateFPS(t),this.spawnRedPacket(),this.updateRedPackets(i),this.updateParticles(i),this.renderRedPackets(),this.renderParticles(),this.config.debugMode&&this.renderDebugInfo(),this.triggerCallbacks()),this.isRunning&&!this.isPaused&&(this.animationId=requestAnimationFrame(this.animate.bind(this)))}updateFPS(t){this.frameCount++,t-this.lastFpsTime>=1e3&&(this.stats.fps=this.frameCount,this.frameCount=0,this.lastFpsTime=t)}renderDebugInfo(){const t=this.ctx;t.save(),t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(10,10,300,120),t.fillStyle="#00FF00",t.font="14px Arial",t.textAlign="left",t.fillText(`FPS: ${this.stats.fps}`,15,30),t.fillText(`Á∫¢ÂåÖÊï∞Èáè: ${this.redPackets.length}`,15,50),t.fillText(`Á≤íÂ≠êÊï∞Èáè: ${this.particles.length}`,15,70),t.fillText(`CanvasÂ∞∫ÂØ∏: ${this.actualWidth}x${this.actualHeight}`,15,90),t.fillText(`ÁÇπÂáªËÆ∞ÂΩï: ${this.debugClicks.length}`,15,110);for(const e of this.redPackets){const i=e.x+e.width/2,a=e.y+e.height/2,s=e.width*e.scale,o=e.height*e.scale,n=s+.1*s,c=o+.1*o;t.strokeStyle="rgba(255, 0, 0, 0.5)",t.lineWidth=1,t.strokeRect(i-s/2,a-o/2,s,o),t.strokeStyle="rgba(0, 255, 0, 0.7)",t.lineWidth=2,t.strokeRect(i-n/2,a-c/2,n,c),t.fillStyle="rgba(0, 255, 255, 0.8)",t.fillRect(i-2,a-2,4,4)}const e=Date.now();for(const i of this.debugClicks){const a=e-i.time;if(a<2e3){const e=Math.max(0,1-a/2e3);t.fillStyle=i.hit?`rgba(0, 255, 0, ${e})`:`rgba(255, 0, 0, ${e})`,t.fillRect(i.x-5,i.y-5,10,10),t.strokeStyle=i.hit?`rgba(0, 255, 0, ${e})`:`rgba(255, 0, 0, ${e})`,t.lineWidth=2,t.beginPath(),t.arc(i.x,i.y,15,0,2*Math.PI),t.stroke()}}t.restore()}triggerCallbacks(){this.onAnimationStateChangeCallback&&this.onAnimationStateChangeCallback({isRunning:this.isRunning,isPaused:this.isPaused,totalCollected:this.stats.totalCollected,currentRedPackets:[...this.redPackets],fps:this.stats.fps}),this.onPerformanceUpdateCallback&&this.onPerformanceUpdateCallback({fps:this.stats.fps,renderTime:0,updateTime:0,totalRedPackets:this.stats.totalCollected,activeRedPackets:this.redPackets.length})}start(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate(this.lastFrameTime))}stop(){this.isRunning=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}pause(){this.isPaused=!0}resume(){this.isPaused&&this.isRunning&&(this.isPaused=!1,this.lastFrameTime=performance.now(),this.animate(this.lastFrameTime))}clear(){this.redPackets.forEach(t=>this.returnRedPacketToPool(t)),this.redPackets=[],this.particles.forEach(t=>this.returnParticleToPool(t)),this.particles=[],this.ctx.clearRect(0,0,this.actualWidth,this.actualHeight),this.stats.totalCollected=0,this.stats.totalValue=0}updateConfig(t){this.config={...this.config,...t},this.optimizeConfig(),this.resizeCanvas(),t.redPacketImage&&this.loadRedPacketImage(),t.redPackets&&(this.redPacketDataIndex=0)}getStats(){return{fps:this.stats.fps,renderTime:0,updateTime:0,totalRedPackets:this.stats.totalCollected,activeRedPackets:this.redPackets.length}}getCollectionStats(){return{totalCollected:this.stats.totalCollected,totalValue:this.stats.totalValue}}setPerformanceMode(t){this.config.enablePerformanceMode=t}getPerformanceMode(){return this.config.enablePerformanceMode}onRedPacketClick(t){this.onRedPacketClickCallback=t}onAnimationStateChange(t){this.onAnimationStateChangeCallback=t}onPerformanceUpdate(t){this.onPerformanceUpdateCallback=t}setParticleConfig(t){this.particleConfig={...this.particleConfig,...t}}getParticleConfig(){return{...this.particleConfig}}destroy(){this.stop(),this.clear(),this.debugClicks=[],this.lastClickTime=0,this.particlePool=[],this.canvas.removeEventListener("click",this.handleClick.bind(this)),this.canvas.removeEventListener("touchstart",this.handleTouch.bind(this)),window.removeEventListener("resize",this.handleResize.bind(this))}};
//# sourceMappingURL=RedPacketRainEngine.js.map
